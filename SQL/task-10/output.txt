mysql> source /Users/sachinsabariram/Desktop/Presedio/Presedio-PreInternship/SQL/task-10/query.sql

+-------------------------------+
| test                          |
+-------------------------------+
| === Initial Product Stock === |
+-------------------------------+
1 row in set (0.00 sec)

+------------+--------+-------+
| product_id | name   | stock |
+------------+--------+-------+
|          1 | Laptop |    10 |
|          2 | Phone  |    15 |
+------------+--------+-------+
2 rows in set (0.00 sec)

+---------------------------+
| test                      |
+---------------------------+
| === Initial Customers === |
+---------------------------+
1 row in set (0.00 sec)

+-------------+------------------+
| customer_id | email            |
+-------------+------------------+
|           2 | jane@example.com |
|           1 | john@example.com |
+-------------+------------------+
2 rows in set (0.00 sec)

+---------------------------------+
| test                            |
+---------------------------------+
| 
=== Processing Valid Order === |
+---------------------------------+
1 row in set (0.00 sec)

+------------------------------------+
| result                             |
+------------------------------------+
| Transaction completed successfully |
+------------------------------------+
1 row in set (0.00 sec)

+--------------------------------+
| test                           |
+--------------------------------+
| === Post-Transaction Stock === |
+--------------------------------+
1 row in set (0.00 sec)

+------------+--------+-------+
| product_id | name   | stock |
+------------+--------+-------+
|          1 | Laptop |     8 |
|          2 | Phone  |    15 |
+------------+--------+-------+
2 rows in set (0.00 sec)

+-----------------------+
| test                  |
+-----------------------+
| === Order Details === |
+-----------------------+
1 row in set (0.00 sec)

+----------+--------------+------------+----------+-------------------+
| order_id | total_amount | product_id | quantity | price_at_purchase |
+----------+--------------+------------+----------+-------------------+
|        1 |      1999.98 |          1 |        2 |            999.99 |
+----------+--------------+------------+----------+-------------------+
1 row in set (0.00 sec)

+-------------------------------------+
| test                                |
+-------------------------------------+
| 
=== Testing Insufficient Stock === |
+-------------------------------------+
1 row in set (0.00 sec)

+----------------------------------+
| result                           |
+----------------------------------+
| Transaction failed - rolled back |
+----------------------------------+
1 row in set (0.00 sec)

+----------------------------+
| test                       |
+----------------------------+
| 
=== Testing Audit Log === |
+----------------------------+
1 row in set (0.00 sec)

Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
| audit_id | table_name | record_id | action | old_data                                         | new_data                                         | changed_at          |
+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
|        1 | Products   |         1 | UPDATE | {"name": "Laptop", "price": 999.99, "stock": 10} | {"name": "Laptop", "price": 999.99, "stock": 8}  | 2025-04-14 10:56:53 |
|        2 | Products   |         1 | UPDATE | {"name": "Laptop", "price": 999.99, "stock": 8}  | {"name": "Laptop", "price": 1099.99, "stock": 8} | 2025-04-14 10:56:53 |
+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
2 rows in set (0.00 sec)

+------------------------------------------+
| test                                     |
+------------------------------------------+
| 
=== Testing Foreign Key Constraints === |
+------------------------------------------+
1 row in set (0.00 sec)

ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`ecommercedb`.`orders`, CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`customer_id`))
Query OK, 0 rows affected (0.00 sec)

ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`ecommercedb`.`orderdetails`, CONSTRAINT `orderdetails_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `products` (`product_id`))
Query OK, 0 rows affected (0.00 sec)

+-------------------------------+
| test                          |
+-------------------------------+
| 
=== Testing Unique Email === |
+-------------------------------+
1 row in set (0.00 sec)

ERROR 1062 (23000): Duplicate entry 'john@example.com' for key 'customers.email'
Query OK, 0 rows affected (0.00 sec)

+--------------------------------------+
| test                                 |
+--------------------------------------+
| 
=== Customer Order Summary View === |
+--------------------------------------+
1 row in set (0.00 sec)

+-------------+---------------+--------------+-------------+
| customer_id | customer_name | total_orders | total_spent |
+-------------+---------------+--------------+-------------+
|           1 | John Doe      |            1 |     1999.98 |
|           2 | Jane Smith    |            0 |        0.00 |
+-------------+---------------+--------------+-------------+
2 rows in set (0.01 sec)

+---------------------------------------+
| test                                  |
+---------------------------------------+
| 
=== Testing Transaction Rollback === |
+---------------------------------------+
1 row in set (0.00 sec)

+-----------------------------------+
| test                              |
+-----------------------------------+
| === Pre-Rollback Verification === |
+-----------------------------------+
1 row in set (0.00 sec)

+----------+-------------+---------------------+------------+--------------+
| order_id | customer_id | order_date          | status     | total_amount |
+----------+-------------+---------------------+------------+--------------+
|        1 |           1 | 2025-04-14 10:56:53 | Processing |      1999.98 |
|        4 |           2 | 2025-04-14 10:56:53 | Processing |      3499.95 |
+----------+-------------+---------------------+------------+--------------+
2 rows in set (0.00 sec)

+------------------------------------+
| test                               |
+------------------------------------+
| === Post-Rollback Verification === |
+------------------------------------+
1 row in set (0.00 sec)

+----------+-------------+---------------------+------------+--------------+
| order_id | customer_id | order_date          | status     | total_amount |
+----------+-------------+---------------------+------------+--------------+
|        1 |           1 | 2025-04-14 10:56:53 | Processing |      1999.98 |
+----------+-------------+---------------------+------------+--------------+
1 row in set (0.00 sec)

+----------------------+
| test                 |
+----------------------+
| === Final Tables === |
+----------------------+
1 row in set (0.00 sec)

+-------------+------------+-----------+------------------+-------------+---------------------+---------------------+
| customer_id | first_name | last_name | email            | address     | created_at          | updated_at          |
+-------------+------------+-----------+------------------+-------------+---------------------+---------------------+
|           1 | John       | Doe       | john@example.com | 123 Main St | 2025-04-14 10:56:53 | 2025-04-14 10:56:53 |
|           2 | Jane       | Smith     | jane@example.com | 456 Oak Ave | 2025-04-14 10:56:53 | 2025-04-14 10:56:53 |
+-------------+------------+-----------+------------------+-------------+---------------------+---------------------+
2 rows in set (0.00 sec)

+------------+--------+-------------------------+---------+-------+---------------------+---------------------+
| product_id | name   | description             | price   | stock | created_at          | updated_at          |
+------------+--------+-------------------------+---------+-------+---------------------+---------------------+
|          1 | Laptop | High-performance laptop | 1099.99 |     8 | 2025-04-14 10:56:53 | 2025-04-14 10:56:53 |
|          2 | Phone  | Latest smartphone       |  699.99 |    15 | 2025-04-14 10:56:53 | 2025-04-14 10:56:53 |
+------------+--------+-------------------------+---------+-------+---------------------+---------------------+
2 rows in set (0.00 sec)

+----------+-------------+---------------------+------------+--------------+
| order_id | customer_id | order_date          | status     | total_amount |
+----------+-------------+---------------------+------------+--------------+
|        1 |           1 | 2025-04-14 10:56:53 | Processing |      1999.98 |
+----------+-------------+---------------------+------------+--------------+
1 row in set (0.00 sec)

+-----------------+----------+------------+----------+-------------------+
| order_detail_id | order_id | product_id | quantity | price_at_purchase |
+-----------------+----------+------------+----------+-------------------+
|               1 |        1 |          1 |        2 |            999.99 |
+-----------------+----------+------------+----------+-------------------+
1 row in set (0.00 sec)

+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
| audit_id | table_name | record_id | action | old_data                                         | new_data                                         | changed_at          |
+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
|        1 | Products   |         1 | UPDATE | {"name": "Laptop", "price": 999.99, "stock": 10} | {"name": "Laptop", "price": 999.99, "stock": 8}  | 2025-04-14 10:56:53 |
|        2 | Products   |         1 | UPDATE | {"name": "Laptop", "price": 999.99, "stock": 8}  | {"name": "Laptop", "price": 1099.99, "stock": 8} | 2025-04-14 10:56:53 |
+----------+------------+-----------+--------+--------------------------------------------------+--------------------------------------------------+---------------------+
2 rows in set (0.00 sec)